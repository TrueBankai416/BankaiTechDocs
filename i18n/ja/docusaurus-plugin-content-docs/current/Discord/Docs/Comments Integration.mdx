---
title: コメント統合
description: セットアップ、構成、トラブルシューティングなど、双方向 Discord コメントを Docusaurus と統合するための完全なガイド。
image: /img/social/discord-social.jpg
sidebar_position: 2
---

# Discordコメント統合

このドキュメント サイトには、**双方向の Discord コメント統合** が含まれており、訪問者は Discord サーバーにコメントを送信でき、既存の GitHub ベースの Giscus コメントと一緒に Discord の返信を Web サイトに表示できます。

## 特徴

* **双方向通信**: ウェブサイトのコメント → Discord、Discord の返信 → ウェブサイト
* **デュアルコメントシステム**: Giscus（GitHubベース）とDiscordのコメントは連携して動作します
* **リッチ Discord 埋め込み**: コメントは、ページ全体のコンテキストを含むフォーマットされた埋め込みとして表示されます。
* **スレッド管理**: 整理された返信のための自動スレッド作成
* **リアルタイム更新**: ウェブサイトは Discord の返信を自動的に表示します
* **ページ全体のコンテキスト**: コメントには、ページタイトル、URL、ナビゲーションコンテキストが含まれます
* **ユーザーアバター**: Discordの返信にユーザーアバターとユーザー名が表示されます
* **レスポンシブデザイン**: デスクトップとモバイルデバイスの両方で動作します

## セットアップ手順

### 1. Discordボットを作成する

1. [Discord 開発者ポータル](https://discord.com/developers/applications)に移動します
2. 新しいアプリケーションを作成する
3. 「ボット」セクションに移動してボットを作成します
4. ボットトークンをコピーする
5. 「特権ゲートウェイ インテント」の下で、以下を有効にします。
   * **メッセージコンテンツの意図**
   * **サーバーメンバーの意図** (オプション)

### 3) Invite Bot to Server

ボットには次の権限が必要です:

* メッセージを読む
* メッセージを送信
* 公開スレッドを作成する
* スレッドでメッセージを送信する
* メッセージ履歴を読む
* スラッシュコマンドを使用する（オプション）

### 6. Start the Backend Server

1. OAuth2 > URLジェネレーターへ移動
2. 「ボット」スコープを選択
3. 上記の権限を選択してください
4. 生成されたURLを使用してボットをサーバーに招待します

### 7) Deploy Configuration

#### フロントエンド (.env)

```env
# Discord ボット設定
DISCORD_BOT_TOKEN=your_bot_token_here
DISCORD_CHANNEL_ID=your_channel_id_here

# API 設定
REACT_APP_API_URL=http://localhost:3001

# Discord コンテキスト設定
DISCORD_CONTEXT_LEVEL=full
DISCORD_SHOW_BREADCRUMBS=true
DISCORD_SHOW_SECTION_INFO=true
DISCORD_SITE_NAME=サイト名
```

#### バックエンドサーバー (server/.env)

```env
# Discord ボット設定
DISCORD_BOT_TOKEN=your_bot_token_here
DISCORD_CHANNEL_ID=your_channel_id_here

# API 設定
PORT=3001

# Discord コンテキスト設定
DISCORD_CONTEXT_LEVEL=full
DISCORD_SHOW_PAGE_CONTEXT=true
DISCORD_SHOW_BREADCRUMBS=true
DISCORD_SHOW_SECTION_INFO=true
DISCORD_SHOW_PAGE_PATH=false
DISCORD_SHOW_TIMESTAMP=true
DISCORD_SHOW_AUTHOR_FIELD=true
DISCORD_CREATE_THREADS=true
DISCORD_THREAD_DURATION=1440
DISCORD_SITE_NAME=サイト名
```

:::警告 セキュリティに関する注意事項

* `.env` ファイルをバージョン管理にコミットしないでください
* 本番環境で環境変数を使用する
* ボットトークンを安全に保管してください
  :::

### 5. サーバーの依存関係をインストールする

```bash
cd サーバー
npm インストール
```

### 6. バックエンドサーバーを起動する

```bash
# 開発
npm run dev

# 本番環境
npm start
```

### 7. 構成の展開

実稼働環境へのデプロイメントでは、ホスティング プラットフォームで環境変数を設定します。

* **フロントエンド**: `REACT_APP_API_URL` を本番環境の API URL に設定します
* **バックエンド**: ボットトークンとチャンネルIDを含むサーバーフォルダを展開します
* **データベース**: SQLiteデータベースが自動的に作成されます
* **コンテキスト**: Discord のコンテキスト レベルとオプションを好みに応じて設定します

## 仕組み

### 完全な双方向フロー

1. **ウェブサイトコメント**: ユーザーがウェブサイトのフォームからコメントを送信します
2. **Discord メッセージ**: ボットは、完全なページ コンテキストを含むフォーマットされた埋め込みを Discord チャネルに送信します。
3. **スレッド作成**: ボットは整理された返信用のスレッドを自動的に作成します
4. **Discord返信**: Discordユーザーはスレッドまたはメッセージに返信します
5. **データベースストレージ**: ボットはすべてのコメントと返信をSQLiteデータベースに保存します
6. **ウェブサイトの表示**: フロントエンドは30秒ごとにAPIをポーリングし、Discordの返信を表示します。

### Discordメッセージの形式

Discord 埋め込みには次のものが含まれます:

* **Title**: "💬 New Comment: \{Page Title}"
* **説明**: 実際のコメント内容
* **著者**: コメント投稿者の名前
* **URL**: 正確なページへのクリック可能なリンク
* **ページフィールド**: クリック可能なリンクを含むページタイトルを表示します
* **タイムスタンプ**: コメントが投稿された日時
* **スレッド**: 返信用に自動作成されたスレッド

### ウェブサイトの表示

ウェブサイトには次の内容が表示されます:

* **元のコメント**: ウェブサイトのフォーム送信
* **Discord返信**: アバターとユーザー名を持つDiscordユーザーからの返信
* **リアルタイム更新**: 新しい返信の自動ポーリング
* **スレッド化された会話**: 整理されたコメント→返信構造

## コンテキスト構成

### コンテキストレベル

Discord メッセージに表示されるコンテキストの量を設定します。

#### `DISCORD_CONTEXT_LEVEL=最小限`

* **表示**: ページタイトルとコメントの内容のみ
* **ユースケース**: 余分なコンテキストのない、簡潔でシンプルなメッセージ

#### `DISCORD_CONTEXT_LEVEL=基本`

* **表示**: ページタイトル、コメント内容、クリック可能なページ URL
* **使用例**: 重要な情報を含む中程度のコンテキスト

#### `DISCORD_CONTEXT_LEVEL=full` (デフォルト)

* **表示**: パンくずリスト、セクション、タイムスタンプを含むすべてのコンテキスト情報
* **ユースケース**: 詳細な議論のための最大限のコンテキスト

#### `DISCORD_CONTEXT_LEVEL=カスタム`

* **表示**: 個別に有効にしたコンテキスト要素のみ
* **ユースケース**: 表示される内容を細かく制御する

### 個別のコンテキストコントロール

`DISCORD_CONTEXT_LEVEL=custom` を使用する場合、各要素を制御できます。

```env
DISCORD_SHOW_PAGE_CONTEXT=true # ページタイトルと URL フィールドを表示します
DISCORD_SHOW_BREADCRUMBS=true # ナビゲーション ブレッドクラムを表示します
DISCORD_SHOW_SECTION_INFO=true # メイン セクション (Docker、Nextcloud など) を表示します
DISCORD_SHOW_PAGE_PATH=false # 完全な URL パスを表示します
DISCORD_SHOW_TIMESTAMP=true # コメントが投稿された日時を表示します
DISCORD_SHOW_AUTHOR_FIELD=true # 埋め込み作成者としてコメント投稿者の名前を表示します
```

### スレッド構成

```env
DISCORD_CREATE_THREADS=true # 返信用のスレッドを作成する
DISCORD_THREAD_DURATION=1440 # スレッドの自動アーカイブ時間（分）
DISCORD_SITE_NAME=サイト名 # フッターにサイト名を表示する
```

### コンテキスト出力の例

**最小限のコンテキスト:**

```
Docker インストール ガイド
「このチュートリアルは本当に役に立ちました。ポートの競合にはどのように対処すればよいですか?」
```

**基本的なコンテキスト:**

```
💬 Docker インストールガイド
「このチュートリアルは本当に役に立ちました！ポートの競合をどう処理すればいいですか？」
[ページへのリンク]
```

**完全なコンテキスト:**

```
💬 新しいコメント: Docker インストールガイド
👤 John Doe
「このチュートリアルは本当に役に立ちました！ポートの競合はどのように処理すればいいですか？」

📄 ページ: Docker インストールガイド
📍 ナビゲーション: Docker > ドキュメント > Docker のインストール
📂 セクション: Docker
🔗 パス: /Docker/Docs/Installing%20Docker/Docker%20Engine

あなたのサイト名 • コメントシステム
```

## カスタマイズ

### スタイリング

Discord コメント コンポーネントは CSS モジュールを使用します。 以下を変更することで外観をカスタマイズできます。

```
src/components/DiscordComments/styles.module.css
```

### メッセージ形式

Discord 埋め込み形式をカスタマイズするには、次の `discordMessage` オブジェクトを編集します。

```
src/components/DiscordComments/index.tsx
```

### 部品配置

Discord のコメントは、デフォルトで Giscus のコメントの下に表示されます。 これを変更するには、以下を変更します。

```
src/theme/DocItem/Layout/index.js
```

## トラブルシューティング

### ボットが応答しない

1. **ボットトークンを確認**: `DISCORD_BOT_TOKEN` が正しいことを確認してください
2. **権限を確認**: ボットがチャネル内で必要な権限を持っていることを確認します
3. **チャンネルIDを確認してください**: `DISCORD_CHANNEL_ID`が正しいことを確認してください
4. **サーバー内のボット**: ボットが実際に Discord サーバーに存在することを確認します

### コメントが表示されない

1. **サーバー実行中**: バックエンドサーバーが正しいポートで実行されているかどうかを確認します
2. **API URL**: `REACT_APP_API_URL` がバックエンド サーバーを指していることを確認します
3. **データベース**: サーバーフォルダにSQLiteデータベースが作成されているかどうかを確認します
4. **CORS**: フロントエンドドメインに CORS が設定されていることを確認してください

### Discordの返信が表示されない

1. **メッセージコンテンツの意図**: Discord開発者ポータルでこれが有効になっていることを確認してください
2. **ボットの権限**: ボットがチャンネル内のメッセージを読み取れることを確認する
3. **データベース接続**: サーバーログでデータベースエラーを確認してください
4. **ポーリング**: フロントエンドは30秒ごとにポーリングします - 返信が表示されるまで時間がかかる場合があります

### 環境変数が機能しない

* **開発**: フロントエンドサーバーとバックエンドサーバーの両方を再起動します
* **本番**: 正しい環境変数を使用してフロントエンドとバックエンドの両方を再デプロイします
* **プレフィックス**: フロントエンド変数には `REACT_APP_` プレフィックスのみを使用してください

### データベースの問題

1. **ファイル権限**: サーバーがデータベースディレクトリに書き込み可能であることを確認する
2. **ディスク容量**: SQLiteデータベースの使用可能なディスク容量を確認します
3. **サーバーログ**: サーバーコンソールでデータベース接続エラーを確認してください

## セキュリティに関する考慮事項

* **ボットトークン**: ボットトークンを秘密にして、バージョン管理にコミットしないでください。
* **レート制限**: Discord にはボットのレート制限があります (Webhook とは異なります)
* **入力検証**: フロントエンドとバックエンドの両方でユーザー入力を検証します
* **データベースセキュリティ**: SQLiteデータベースは適切なファイル権限で保護する必要があります
* **API セキュリティ**: API エンドポイントにレート制限を実装することを検討してください
* **CORS**: 本番ドメインにCORSを適切に設定します

## 建築

```
ウェブサイトフロントエンド ←→ Express API ←→ Discord ボット ←→ Discord サーバー
                    ↓
                SQLite データベース
```

## ファイル構造

```
project/
├── src/components/DiscordComments/ # フロントエンドコンポーネント
├── server/ # バックエンドサーバー
│ ├── api.js # Express APIサーバー
│ ├── discord-bot.js # Discordボットロジック
│ ├── database.js # SQLiteデータベース関数
│ └── package.json # サーバー依存関係
└── docs/Discord/Docs/ # ドキュメント
```

## ブラウザのサポート

Discord コメント コンポーネントは、以下をサポートするすべての最新ブラウザーで動作します。

* ES6 フェッチ API
* リアクト18歳以上
* CSSグリッドとフレックスボックス
* ローカルストレージ（フォームの永続化用）
