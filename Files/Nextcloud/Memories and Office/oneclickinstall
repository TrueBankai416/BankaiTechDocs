# /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/TrueBankai416/BankaiTechDocs/main/Files/Nextcloud/Memories%20and%20Office/oneclickinstall)" 
#!/bin/bash

set -e

export DEBIAN_FRONTEND=noninteractive
# Automatically restart without asking.
# this gets around needrestart command halting for user input
export RESTART_MODE=l

# Check if Docker is installed
if ! command -v docker &> /dev/null
then
    echo "Docker could not be found."
    read -p "Do you want to install Docker? (y/N): " install_docker
    if [[ "$install_docker" =~ ^[Yy]$ ]]
    then
        echo "Installing Docker..."
        sudo apt-get update
        sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
        sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io
        echo "Docker installed successfully."
    else
        echo "Docker installation aborted. Exiting script."
        exit 1
    fi
fi

# Update Docker
echo "Updating Docker..."
sudo apt-get update && sudo apt-get install docker-ce docker-ce-cli containerd.io -y

# Prompt user for Nextcloud installation option
echo "Select the Nextcloud installation option:"
echo "1) Just Nextcloud"
echo "2) Nextcloud with Office"
echo "3) Nextcloud with Memories support"
read -p "Enter your choice (1/2/3): " INSTALL_OPTION

# Prompt user for Domain
echo "What is the your nextcloud domain? "
echo "Example: cloud.bankai-tech.com"
read -p "Enter your domain: " DOMAIN_NAME

# Prompt user for Reverse-Proxy IP address
echo "Enter the private ip address for your reverse proxy "
read -p "Enter here: " PROXY_IP

# Prompt user to select nextclouds listening port
echo "What port would you like nextcloud to listen on? (Default: 8080) "
read -p "Enter port: " PORT

# Create directory for Docker Nextcloud
NEXTCLOUD_DIR="/etc/docker/nextcloud"
if [ ! -d "$NEXTCLOUD_DIR" ]; then
    echo "Creating directory $NEXTCLOUD_DIR..."
    sudo mkdir -p "$NEXTCLOUD_DIR"
fi

# Navigate to the Nextcloud directory
cd "$NEXTCLOUD_DIR"

# Create .env file
cat << EOF > .env
# Environment variables for Nextcloud docker-compose setup
EOF

# Generate random passwords for MySQL
MYSQL_PASSWORD=$(openssl rand -base64 12)
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 12)

# Generate random passwords for Collabora
COLLABORA_PASSWORD=$(openssl rand -base64 12)

# Create .env file with common environment variables based on selection
case $INSTALL_OPTION in
    1)
        cat << EOF > .mariadb.env
# Common Environment variables for Nextcloud docker-compose setup
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_PASSWORD=$MYSQL_PASSWORD
MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
EOF
        cat << EOF > .nextcloud.env
NEXTCLOUD_TRUSTED_DOMAINS=$DOMAIN_NAME
TRUSTED_PROXIES=PROXY_IP
OVERWRITEPROTOCOL=https
OVERWRITECLIURL=https://$DOMAIN_NAME
OFFICE_ENABLED=1
REDIS_HOST=redis
REDIS_PORT=6379
PHP_MEMORY_LIMIT=512M
PHP_UPLOAD_LIMIT-512M
MYSQL_PASSWORD=$MYSQL_PASSWORD
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_HOST=mariadb
EOF
        ;;
    2)
        cat << EOF > .mariadb.env
# Common Environment variables for Nextcloud docker-compose setup
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_PASSWORD=$MYSQL_PASSWORD
MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
EOF
        cat << EOF > .nextcloud.env
NEXTCLOUD_TRUSTED_DOMAINS=$DOMAIN_NAME
TRUSTED_PROXIES=PROXY_IP
OVERWRITEPROTOCOL=https
OVERWRITECLIURL=https://$DOMAIN_NAME
OFFICE_ENABLED=1
REDIS_HOST=redis
REDIS_PORT=6379
PHP_MEMORY_LIMIT=512M
PHP_UPLOAD_LIMIT-512M
MYSQL_PASSWORD=$MYSQL_PASSWORD
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_HOST=mariadb
EOF
        cat << EOF > .collabora.env
username=admin
password=$COLLABORA_PASSWORD
domain=cloud\\.domain\\.com
EOF
        ;;
    3)
        cat << EOF > .mariadb.env
# Common Environment variables for Nextcloud docker-compose setup
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_PASSWORD=$MYSQL_PASSWORD
MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
EOF
        cat << EOF > .nextcloud.env
NEXTCLOUD_TRUSTED_DOMAINS=$DOMAIN_NAME
TRUSTED_PROXIES=PROXY_IP
OVERWRITEPROTOCOL=https
OVERWRITECLIURL=https://$DOMAIN_NAME
OFFICE_ENABLED=1
MEMORIES_ENABLED=1
REDIS_HOST=redis
REDIS_PORT=6379
PHP_MEMORY_LIMIT=512M
PHP_UPLOAD_LIMIT-512M
MYSQL_PASSWORD=$MYSQL_PASSWORD
MYSQL_DATABASE=nextcloud
MYSQL_USER=nextcloud
MYSQL_HOST=mariadb
EOF
        cat << EOF > .collabora.env
username=admin
password=$COLLABORA_PASSWORD
domain=cloud\\.domain\\.com
EOF
        ;;
    *)
        echo "Invalid option selected. Exiting."
        exit 1
        ;;
esac

echo "Creating docker-compose.yaml file..."
case $INSTALL_OPTION in
    1)
        cat << EOF > docker-compose.yaml
name: nextcloud

services:
  mariadb:
    image: mariadb:10.6
    container_name: mariadb
    restart: always
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - ./mariadb:/var/lib/mysql
    env_file:
      - .mariadb.env

  nextcloud:
    image: nextcloud:production
    container_name: nextcloud
    restart: unless-stopped
    ports:
      - $PORT:80
    links:
      - mariadb
      - redis
      - collabora
    volumes:
      - ./nextcloud:/var/www/html
    env_file:
      - .nextcloud.env

  redis:
    container_name: redis
    image: redis:latest
    expose:
      - 6379
    command: redis-server --save 60 1 --loglevel warning
    restart: always
EOF
        ;;
    2)
        cat << EOF > docker-compose.yaml
name: nextcloud

services:
  mariadb:
    image: mariadb:10.6
    container_name: mariadb
    restart: always
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - ./mariadb:/var/lib/mysql
    env_file:
      - .mariadb.env

  nextcloud:
    image: nextcloud:production
    container_name: nextcloud
    ports:
      - "$PORT:80"
    links:
      - mariadb
      - redis
      - collabora
    volumes:
      - ./nextcloud:/var/www/html
    restart: unless-stopped
    env_file:
      - .nextcloud.env

  redis:
    container_name: redis
    image: redis:latest
    expose:
      - 6379
    command: redis-server --save 60 1 --loglevel warning
    restart: always

  collabora:
    image: collabora/code:latest
    container_name: collabora
    restart: always
    privileged: true
    tty: true
    environment:
      - domain=nextcloud\.localhost
      - username=admin
      - password=admin
    cap_add:
      - MKNOD
    ports:
      - "9980:9980"

EOF
        ;;
    3)
        cat << EOF > docker-compose.yaml
name: nextcloud

services:
  mariadb:
    image: mariadb:10.6
    container_name: mariadb
    restart: always
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - ./mariadb:/var/lib/mysql
    env_file:
      - .mariadb.env

  nextcloud:
    image: bankaitech/nextcloud:latest
    container_name: nextcloud
    ports:
      - "$PORT:80"
    links:
      - mariadb
      - redis
      - collabora
    volumes:
      - ./nextcloud:/var/www/html
    restart: unless-stopped
    env_file:
      - .nextcloud.env

  redis:
    container_name: redis
    image: redis:latest
    expose:
      - 6379
    command: redis-server --save 60 1 --loglevel warning
    restart: always

  collabora:
    image: collabora/code:latest
    container_name: collabora
    restart: always
    privileged: true
    tty: true
    environment:
      - domain=nextcloud\.localhost
      - username=admin
      - password=admin
    cap_add:
      - MKNOD
    ports:
      - "9980:9980"
EOF
        ;;
    *)
        echo "Invalid option selected. Exiting."
        exit 1
        ;;
esac

echo "docker-compose.yaml file created successfully."

# Start Nextcloud using Docker Compose
echo "Starting Nextcloud..."
sudo docker compose up -d

echo "Nextcloud has been started successfully."
